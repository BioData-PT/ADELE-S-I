# TLS example

This folder contains example files that can be used as a base when the setup requires TLS enabled in the deployment.

**Note** this is not usable as is, manual intervention is required.

## Configuration example

### config.yaml file

In the `config.yaml` the following entries must be set:

```yaml
archive:
    url:
    accesskey:
    secretkey:

inbox:
    url:
    accesskey:
    secretkey:

c4gh:
    passphrase:

elixir:
    id:
    secret:
    redirectUrl:

session:
    domain:

s3inbox:
```

The `config.yaml` contains comments to help setting the correct value

### env file

The following entries in the env file need to be set:

- `C4GH_KEYPATH`: path to the crypt4gh private key.
- `rabbitmq_MQ_PASSWORD`: admin password to the RabbitMQ server
- `rabbitmq_MQ_USER`: username for the RabbitMQ admin
- `postgres_POSTGRES_PASSWORD`: password for the `postgres` user

After which the file needs to be renamed with a dot prefix (`.env`)

#### service credentials

These credentials can be created manually in Postgres/RabbitMQ, or with the use of the `make_credentials` script once the RabbitMQ and Postgres containers are running. The usernames should be the same as the `container_name` in the docker-compose file

##### RabbitMQ

- finalize_BROKER_PASSWORD
- ingest_BROKER_PASSWORD
- mapper_BROKER_PASSWORD
- verify_BROKER_PASSWORD
- inbox_BROKER_PASSWORD

##### Postgres

- download_DB_PASSWORD
- finalize_DB_PASSWORD
- ingest_DB_PASSWORD
- mapper_DB_PASSWORD
- verify_DB_PASSWORD
- inbox_DB_PASSWORD

### iss.json file

In the `iss.json` file a block for the publicly available endpoint for REMS should to be added.

### certificates

All containers except `auth` needs certificates with DNS entries matching the `container_name` in the docker-compose file.  
These certificate files should adhere to the [cert-manager](https://cert-manager.io/) naming convention (tls.crt, tls.key, ca.crt).

The following containers also need external certificates generated by a public CA like [Let's Encrypt](https://letsencrypt.org/):

- Auth
- Download
- S3inbox

These certificate files should adhere to Let's Encrypts naming schema (fullchain.pem, privkey.pem).

All certificates for a service should be placed in a folder with the same name as the `container_name` and be placed next to the docker-compose file.  
Permissions for the private key need to be set at `0400` and the owner set as shown below:

- rabbitmq - `100:101`
- postgres - `70:70`
- all others - `65534:65534`

If automatic certificate rotation is done through cron it is easier to set the owner to root and group based on the service, with the permissions to `0640` for all files in each folder.

- rabbitmq - `0:101`
- postgres - `0:70`
- all others - `0:65534`

## Bootstrapping

First the RabbitMQ and Postgres servers need to be started.

```cmd
docker compose up -d postgres rabbitmq
```

When they are running with status `healthy`, the credentials for the services can be created, either manually or by executing the `make_credentials` script.

Once the credentials have been created the rest of the services can be started.

```cmd
docker compose up -d
```
